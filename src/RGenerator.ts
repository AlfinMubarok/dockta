import Generator from './Generator'

/**
 * A Dockerfile generator for R environments
 */
export default class RGenerator extends Generator {

  // Methods that override those in `Generator`.
  // See that class for documentation on what each function does

  appliesRuntime (): string {
    return 'R'
  }

  sysVersion (): number {
    // At time of writing, MRAN did not have an ubuntu:18.04(bionic) repo which supported R 3.4 (only bionic_3.5)
    // See https://cran.microsoft.com/snapshot/2018-10-05/bin/linux/ubuntu/
    // So require ubuntu:16.04(xenial).
    return 16.04
  }

  aptRepos (sysVersion: number): Array<[string, string]> {
    // TODO if no date, then use cran
    const sysVersionName = this.sysVersionName(sysVersion)
    const date = this.environ.datePublished
    return [
      [
        `deb https://mran.microsoft.com/snapshot/${date}/bin/linux/ubuntu ${sysVersionName}/`,
        '51716619E084DAB9'
      ]
    ]
  }

  aptPackages (sysVersion: number): Array<string> {
    return ['r-base']
  }

  installFiles (sysVersion: number): Array<[string, string]> {
    // Copy user defined files if they exist
    if (this.exists('install.R')) return [['install.R', '.']]
    if (this.exists('DESCRIPTION')) return [['DESCRIPTION', '.']]

    // Generate a .DESCRIPTION to copy into image
    const pkgs = this.installPackages().map(pkg => pkg.name)
    let desc = `Package: ${this.environ.name}
Version: 1.0.0
Date: ${this.environ.datePublished}
Imports:\n  ${pkgs.join(',\n  ')}
Description: Generated by Dockter ${new Date().toISOString()}.
  To stop Dockter generating this file and start editing it yourself, rename it to "DESCRIPTION".\n`
    this.write('.DESCRIPTION', desc)
    return [['.DESCRIPTION', 'DESCRIPTION']]
  }

  installCommand (sysVersion: number): string | undefined {
    if (this.exists('install.R')) {
      // Run the user supplied installation script
      return `Rscript install.R`
    } else if (this.exists('DESCRIPTION') || this.exists('.DESCRIPTION')) {
      // To keep the Dockerfile as simple as possible, download and
      // execute the installation-from-DESCRIPTION script.
      return `bash -c "Rscript <(curl -s https://stencila.github.io/dockter/install.R)"`
    }
  }

  projectFiles (sysVersion: number): Array<[string, string]> {
    // TODO Copy all R files
    if (this.exists('main.R')) return [['main.R', 'main.R']]
    return []
  }

  runCommand (sysVersion: number): string | undefined {
    if (this.exists('main.R')) return 'Rscript main.R'
  }
}
